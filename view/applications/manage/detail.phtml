<?php 
/**
 * Cross Applicant Management
 *
 * @filesource
 * @copyright (c) 2013 Cross Solution (http://cross-solution.de)
 * @license   AGPLv3
 */

      use Applications\Entity\StatusInterface as Status;
      
      $this->headTitle($this->translate('Details'));
      $this->headScript()->appendFile($this->basePath('Applications/js/applications.manage.detail.js'));
?>
<h1><?= $this->translate('application details') ?></h1>

<div id="forward-email-result" class="hide alert"></div>

<nav class="navbar cam-toolbar"> 
  <form class="navbar-form navbar-right" id="forward-email-form" action="<?php echo $this->url('lang/applications/detail',array(), true)?>" method="get">  
    <div id="forward-email" class="input-group btn-group">  
      <span class="input-group-addon"
            data-toggle="popover" 
            data-trigger="hover focus click"
            data-placement="bottom" 
            title="<?php echo $this->translate('Enter an email address')?>"
            data-content="<?php echo $this->translate('This application will be send as an email to the given address in a layout similar to that on this page with all attachments included.')?>">?</span>
            <input type="hidden" name="action" value="forward">
            <div class="col-md-6">
            <input class="form-control" id="forward-email-input" name="email" type="email">
            </div>
            <button class="btn btn-default" type="submit"><span class="cam-icon-forward"></span><?php echo $this->translate('Forward')?></button>
          </div>
    </form>

  <div class="navbar-text navbar-form cam-color-<?php echo $application->status->name?>">
    <?php echo $this->translate($application->status->name) ?>
  </div>
    
  <div id="state-actions" class="btn-group navbar-form">
        <?php $status = $application->status->getName();
        
            $actionButtons = array(
                Status::CONFIRMED => array(
                    'href' => $this->url(
                                'lang/applications/detail/status',
                                array('status' => Status::CONFIRMED),
                                true
                              ),
                    'label' => $this->translate('Confirm'),
                    'title' => $this->translate('Confirm the receipt'),
                ),
                Status::INVITED => array(
                    'href' => $this->url(
                                'lang/applications/detail/status',
                                array('status' => Status::INVITED),
                                true
                              ),
                    'label' => $this->translate('Invite'),
                    'title' => $this->translate('Invite the applicant'),
                ),
                Status::REJECTED => array(
                    'href' => $this->url(
                                'lang/applications/detail/status',
                                array('status' => Status::REJECTED),
                                true
                              ),
                    'label' => $this->translate('Reject'),
                    'title' => $this->translate('Reject the applicant'),
                ),
                    
            );

            foreach ($actionButtons as $targetStatus => $spec):
                if ($status == $targetStatus): continue; endif?>
              
            <button class="btn btn-default" 
                    data-href="<?php echo $spec['href']?>"
                    <?php if (isset($spec['title'])):?>
                    data-title="<?php echo $spec['title']?>"
                    data-toggle="modal"
                    data-target="#mail-box"
                    <?php endif ?>
            ><?php echo $spec['label'] ?></button>
            <?php endforeach ?>    
        </div>
        
        <div class="btn btn-group navbar-form">
          <button class="btn btn-default"
                    data-title="title"
                    data-toggle="modal"
                    data-target="#cam-application-history">
          <span class="cam-icon-history"></span>
          </button>
          <a class="btn btn-default"
                    href="?format=pdf">
          <span class="cam-icon-download"></span>
          </a>
        </div>
</nav>
<div id="mail-box" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
          <h3 id="mail-box-label">
            <?php echo $this->translate('Invite the applicant') ?>
          </h3>
      </div>
        <div id="mail-box-content" class="modal-body"></div>
        <div class="modal-footer">
          <button class="btn btn-default" data-dismiss="modal" aria-hidden="true"><?php echo $this->translate('Cancel') ?></button>
          <button class="btn btn-primary" onclick="$('#applicant-mail').submit()"><?php echo $this->translate('Send mail') ?></button>
        </div>
     </div>
  </div>
</div>
<div id="cam-application-history" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-dialog">
   <div class="modal-content">
     <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
        <h3 id="history-box-label">
          <?php echo $this->translate('State history') ?>:
        </h3>
      </div>
      <div class="modal-body">
        <table class="table table-striped table-bordered">
        <thead>
            <tr>
                <th><?php echo $this->translate('Date') ?></th>
                <th><?php echo $this->translate('State') ?></th>
                <th><?php echo $this->translate('Comment') ?></th>
            </tr>
        </thead>
        <tbody>
            <?php foreach ($this->application->history as $history): ?>
            <tr>
                <td><?php echo $this->dateFormat($history->date)?></td>
                <td><?php echo $history->status ?></td>
                <td><?php echo $history->message ?></td>
            </tr>
            <?php endforeach ?>
        </tbody>
        </table>     
      </div>
    </div>
  </div>
</div>

<div class="row">
    <div class="col-md-3"><?= $this->translate('date of receipt')?>:</div>
    <div class="col-md-6"><?=  strftime('%x %X', $application->dateCreated->getTimestamp()); ?></div>
</div>
<div class="row">
    <div class="col-md-3"><?= $this->translate('last modification date')?>:</div>
    <div class="col-md-6"><?=  strftime('%x %X', $application->dateModified->getTimestamp()); ?></div>
</div>

<h2><?= $this->translate('personal information')?></h2>
<div class="row">
<div class="col-md-9">
<div class="row">
<div class="col-md-3"><?= $this->translate('name')?>:</div>
<div class="col-md-3"><?=  $this->application->contact->firstName.' '.$this->application->contact->lastName ?></div>
</div>
<?php if (isset($this->application->contact->street)): ?>
<div class="row"> 
<div class="col-md-3"><?php echo $this->translate('Street')?>:</div>
<div class="col-md-3"><?php echo $this->application->contact->street .' '.$this->application->contact->housenumber?></div>
</div>
<?php endif; ?>
<?php if (isset($this->application->contact->city)): ?>
<div class="row">
<div class="col-md-3"><?php echo $this->translate('City')?>:</div>
<div class="col-md-3"><?php echo $this->application->contact->postalcode.' '.$this->application->contact->city ?></div>
</div>
<?php endif; ?>
<div class="row">
<div class="col-md-3"><?= $this->translate('E-Mail')?>:</div>
<div class="col-md-3"><?=  $this->application->contact->email ?></div>
</div>
<div class="row">
<div class="col-md-3"><?= $this->translate('Phone')?>:</div>
<div class="col-md-3"><?=  $this->application->contact->phone ?></div>
</div>
</div>
<div class="col-md-3">
    <?php if ($this->application->contact->image):?>
    <img src="<?php echo $this->url('file', array('filestore' => 'applications', 'fileId' => $this->application->contact->image->id)) ?>" class="img-thumbnail" />
    <?endif?>
</div>
</div>

<h2><?=$this->translate('Summary')?></h2>
<div class="row">
<div class="col-md-12">
<?php echo nl2br($this->application->summary) ?>
</div>
</div>

<?php if(count($this->application->cv->employments)>0):?>
<h2><?= $this->translate('work experience')?></h2>
<table class="table  table-condensed table-bordered "> 
<tr>
 <th class="col-md-1"><?=$this->translate('Start')?></th>
 <th class="col-md-1"><?=$this->translate('End')?></th>
 <th><?=$this->translate('Description')?></th>
</tr>
<?php foreach( $this->application->cv->employments as $employment): ?>
<tr>
 <td><?= $employment->startDate ?></td>
 <td><?= $employment->endDate ?></td>
 <td><?=  $employment->description ?></td>
</tr>
<?php endforeach; // employments?>
</table>
<?php endif;?> 

<?php if(count($this->application->cv->educations)>0):?>
<h2><?= $this->translate('education and training')?></h2>
<table class="table table-condensed table-bordered "> 
<tr>
 <th class="col-md-1"><?=$this->translate('Start')?></th>
 <th class="col-md-1"><?=$this->translate('End')?></th>
 <th><?=$this->translate('Description')?></th>
</tr>
<?php foreach( $this->application->cv->educations as $education): ?>
  <tr>
   <td><?php echo $education->startDate ?></td>
   <td><?php echo $education->endDate ?></td>
   <td><?php echo $education->description ?></td>
  </tr>
<?php endforeach; // eucations?>    
</table>
<?php endif;?> 

<?php if(count($this->application->cv->skills)>0):?>
<h2><?= $this->translate('personal skills')?></h2>
<?php foreach( $this->application->cv->skills as $kill): ?>
  <div class="col-md-3"><?=$this->translate('native language')?></div> 
  <div class="col-md-3">TODO</div>
<?php endforeach; // skills?>
<?php endif;?>

<?php if(count($this->application->attachments)>0):?>
<h2><?= $this->translate('Attachments')?></h2>
<?php foreach( $this->application->attachments as $attachment): ?>
<div class="row show-grid">
  <div class="col-md-3">
    <a href="<?php echo $this->url('file', array(
        'filestore' => 'applications', 
        'fileId' => $attachment->id,
        'fileName' => $attachment->name
    ))?>"><?php echo $attachment->name ?></a></div>
    <div class="col-md-3"><?php echo $attachment->type?></div>
    <div class="col-md-3"><?php echo $attachment->prettySize ?></div>
</div>
<?php endforeach; // skills?>
<?php endif;?>
